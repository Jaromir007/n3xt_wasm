<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STL Slicer</title>
</head>

<body>
    <input type="file" id="fileInput">
    <button id="sliceButton">Slice Model</button>
    <pre id="output"></pre>

    <script type="module">
        import slicerModule from "./slicer.mjs";

        let slicer;
        slicerModule().then((module) => {
            slicer = module;
            console.log("WASM loaded");
        }).catch((err) => {
            console.error("Failed to load WASM:", err);
        });

        let stlDataPointer = null;
        let stlSize = 0;

        document.getElementById("fileInput").addEventListener("change", async (event) => {
            const file = event.target.files[0];
            if (!file || !slicer) return;

            const arrayBuffer = await file.arrayBuffer();
            const byteArray = new Uint8Array(arrayBuffer);
            stlSize = byteArray.length;

            if (stlDataPointer) {
                slicer._free(stlDataPointer);
            }

            stlDataPointer = slicer._malloc(stlSize);
            slicer.HEAPU8.set(byteArray, stlDataPointer);

            const numTriangles = slicer._parseSTL(stlDataPointer, stlSize);
            console.log(`Parsed ${numTriangles} triangles.`);
        });

        document.getElementById("sliceButton").addEventListener("click", () => {
            if (!slicer || !stlDataPointer) {
                console.log("STL file not loaded yet.");
                return;
            }

            const layerHeight = 0.2;
            const numPointsPointer = slicer._malloc(4);

            const pointsPointer = slicer._slice(layerHeight, numPointsPointer);
            const numPoints = slicer.HEAP32[numPointsPointer / 4];

            let points = [];
            for (let i = 0; i < numPoints; i++) {
                const index = (pointsPointer / 4) + i * 3;
                const x = slicer.HEAPF32[index];
                const y = slicer.HEAPF32[index + 1];
                const z = slicer.HEAPF32[index + 2];
                points.push({ x, y, z });
            }

            console.log(`Sliced model into ${numPoints} points.`);
            document.getElementById("output").textContent = JSON.stringify(points, null, 2);

            slicer._free(numPointsPointer);
        });
    </script>
</body>

</html>